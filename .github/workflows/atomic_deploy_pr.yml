name: Deploy via PR from mobile_drop
on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  deploy-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare tools
        run: sudo apt-get update && sudo apt-get install -y unzip rsync

      - name: Ensure mobile_drop zip is available
        run: |
          mkdir -p mobile_drop
          if [ -f "ETHRION_v3.4_MobileReady_Full.zip" ]; then
            cp ETHRION_v3.4_MobileReady_Full.zip mobile_drop/ || true
          fi
          ls -la mobile_drop || true

      - name: Unzip site archive
        run: |
          shopt -s nullglob
          for z in mobile_drop/*.zip; do
            echo "Unzipping $z"
            unzip -o "$z" -d mobile_drop/_unzipped
          done
          if [ ! -d mobile_drop/_unzipped ]; then
            echo "No zip found in mobile_drop"
            exit 1
          fi

      - name: Restore folder structure from double-underscore names
        run: |
          SRC="mobile_drop/_unzipped"
          find "$SRC" -type f | while read -r f; do
            bn="$(basename "$f")"
            if echo "$bn" | grep -q "__"; then
              target_dir="$(echo "$bn" | sed 's@__@/@g' | sed 's@/[^/]*$@@')"
              mkdir -p "$SRC/$target_dir"
              mv "$f" "$SRC/$target_dir/$(echo "$bn" | sed 's@.*__@@')"
            fi
          done

      - name: Create deployment branch
        id: branch
        run: |
          TS=$(date +%s)
          BR="deploy/mobile-drop-${TS}"
          git checkout -b "${BR}"
          echo "${BR}" > .deploy_branch
          echo "::set-output name=branch::${BR}"

      - name: Copy files into branch (preserve .github)
        run: |
          SRC="mobile_drop/_unzipped"
          rsync -a --delete "${SRC}/" ./
          # ensure workflows folder stays intact
          mkdir -p .github/workflows
          ls -la | sed -n '1,200p'

      - name: Commit changes on deployment branch
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add -A
          git commit -m "Deploy from mobile_drop: prepare PR" || echo "Nothing to commit"

      - name: Push deployment branch
        run: |
          BR="$(cat .deploy_branch)"
          git push --set-upstream origin "${BR}"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Deploy from mobile_drop (auto PR)"
          branch: ${{ steps.branch.outputs.branch }}
          title: "Auto deploy: mobile_drop â†’ PR"
          body: "This PR was created by the mobile_drop deploy workflow. Review & merge to publish."
          base: main
