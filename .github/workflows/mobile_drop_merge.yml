name: mobile-drop-merge
on:
  push:
    paths:
      - "mobile_drop/**"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  merge-mobile-drop:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Tools
        run: sudo apt-get update && sudo apt-get install -y unzip rsync
      - name: Unzip zips in mobile_drop (if any)
        run: |
          set -e
          shopt -s nullglob
          for z in mobile_drop/*.zip; do
            mkdir -p mobile_drop/_unzipped
            unzip -o "$z" -d mobile_drop/_unzipped
          done
      - name: Pick source
        id: src
        run: |
          if [ -d "mobile_drop/_unzipped" ]; then
            echo "src=mobile_drop/_unzipped" >> $GITHUB_OUTPUT
          else
            echo "src=mobile_drop" >> $GITHUB_OUTPUT
          fi
      - name: Restore folders from __ (optional)
        run: |
          SRC="${{ steps.src.outputs.src }}"
          find "$SRC" -type f | while read -r f; do
            bn="$(basename "$f")"
            if echo "$bn" | grep -q "__"; then
              dir="$(echo "$bn" | sed 's@__@/@g' | sed 's@/[^/]*$@@')"
              mkdir -p "$SRC/$dir"
              mv "$f" "$SRC/$dir/$(echo "$bn" | sed 's@.*__@@')"
            fi
          done
      - name: Merge (overwrite existing files)
        run: |
          SRC="${{ steps.src.outputs.src }}"
          rsync -a "$SRC"/ ./ --exclude 'mobile_drop/**'
      - name: Commit
        uses: EndBug/add-and-commit@v9
        with:
          add: "."
          message: "Mobile drop: unzip & overwrite merge"
          default_author: github_actions
