name: Atomic Deploy from mobile_drop (force main update)
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  atomic-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (get refs)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare tools
        run: sudo apt-get update && sudo apt-get install -y unzip rsync

      - name: Ensure mobile_drop exists
        run: |
          mkdir -p mobile_drop
          # If user uploaded zip to repo root, copy it into mobile_drop for consistency
          if [ -f "ETHRION_v3.4_MobileReady_Full.zip" ]; then
            cp ETHRION_v3.4_MobileReady_Full.zip mobile_drop/
          fi
          ls -la mobile_drop || true

      - name: Unzip latest site zip
        run: |
          shopt -s nullglob
          for z in mobile_drop/*.zip; do
            echo "Found zip: $z"
            unzip -o "$z" -d mobile_drop/_unzipped
          done
          if [ ! -d mobile_drop/_unzipped ]; then
            echo "No zip found in mobile_drop, failing."
            exit 1
          fi
          ls -la mobile_drop/_unzipped | sed -n '1,200p'

      - name: Restore folder structure from __ pattern (if used)
        run: |
          SRC="mobile_drop/_unzipped"
          find "$SRC" -type f | while read -r f; do
            bn="$(basename "$f")"
            if echo "$bn" | grep -q "__"; then
              target_dir="$(echo "$bn" | sed 's@__@/@g' | sed 's@/[^/]*$@@')"
              mkdir -p "$SRC/$target_dir"
              mv "$f" "$SRC/$target_dir/$(echo "$bn" | sed 's@.*__@@')"
            fi
          done

      - name: Create orphan branch for atomic build
        run: |
          git checkout --orphan atomic-deploy-temp
          git reset --hard
          # ensure .github/workflows kept: copy workflows from checked out remote
          mkdir -p .github/workflows
          if [ -d ".github/workflows" ]; then
            cp -r .github/workflows .github/workflows || true
          fi

      - name: Rsync files from unzipped into repo (preserve .github)
        run: |
          rsync -a --delete mobile_drop/_unzipped/ ./ 
          # remove any accidental mobile_drop copy
          rm -rf ./mobile_drop || true
          ls -la | sed -n '1,200p'

      - name: Commit atomic state
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add -A
          git commit -m "Atomic deploy from mobile_drop (one-push replace main)" || echo "Nothing to commit"

      - name: Force update main with atomic content
        env:
          TARGET_BRANCH: main
        run: |
          # Force-push the current tree to main (replace)
          git push origin HEAD:${TARGET_BRANCH} --force

      - name: Cleanup temp branch (optional)
        run: |
          git checkout main || true
          git branch -D atomic-deploy-temp || true
