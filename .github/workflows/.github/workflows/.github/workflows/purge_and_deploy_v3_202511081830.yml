name: Purge and Deploy ETHRION V3
on:
  workflow_dispatch:

permissions:
  contents: write
  pages: write

jobs:
  purge_and_unzip:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"

      - name: Create backup branch
        run: |
          BACKUP=backup-$(date +%s)
          git checkout -b "$BACKUP"
          git push origin "$BACKUP"
          git checkout main

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y unzip rsync

      - name: Ensure bundle exists
        run: |
          if [ ! -f "ETHRION_v3.4_AllInOne.zip" ] && [ ! -f "ETHRION_web_flattened_upload.zip" ]; then
            echo "ERROR: ETHRION zip not found in repo root."
            exit 1
          fi

      - name: Unzip bundle to temp
        run: |
          rm -rf extracted || true
          mkdir extracted
          if [ -f "ETHRION_v3.4_AllInOne.zip" ]; then
            unzip -q ETHRION_v3.4_AllInOne.zip -d extracted
          else
            unzip -q ETHRION_web_flattened_upload.zip -d extracted
          fi

      - name: Sync extracted -> repo root (overwrite)
        run: |
          rsync -a --delete --exclude='.github/' extracted/ .

      - name: Commit and push changes
        uses: EndBug/add-and-commit@v9
        with:
          author_name: github-actions[bot]
          author_email: actions@github.com
          message: "Auto-deploy V3: Unzip and overwrite with ETHRION v3 bundle"
          add: '.'
          push: true
