name: Ultimate Repository Purge (Files Only)
on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "YES" to confirm the irreversible purge.'
        required: true
        default: 'NO'

permissions:
  contents: write

jobs:
  purge:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'YES'
    steps:
      - name: CHECK Confirmation
        run: |
          echo "Confirmation received. Proceeding with purge."

      - name: Checkout current repo
        uses: actions/checkout@v4
        with:
          # 모든 히스토리를 가져와 초기화 준비
          fetch-depth: 0

      - name: Purge all files except .github
        run: |
          # Git이 추적하는 모든 파일 추적 중지
          git rm -r --cached . || true
          
          # .github 폴더를 제외한 모든 파일과 폴더를 물리적으로 삭제
          find . -mindepth 1 -maxdepth 2 ! -path './.github' ! -path './.github/*' -exec rm -rf {} + || true
          
          # 리포지토리가 완전히 비지 않도록 README.md 파일을 새로 생성
          echo "# Repository Reset" > README.md
          git add README.md
          
          # 새로 생성된 워크플로우 파일 (.github/workflows/ultimate_purge.yml)도 스테이징에 추가
          git add .github/workflows/ultimate_purge.yml

      - name: Commit Purge
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          # 모든 변경사항을 커밋합니다.
          git commit -m "ULTIMATE PURGE: Repository content reset" || echo "Nothing to commit"

      - name: Force Push to main Branch
        # 원격 저장소의 모든 기록을 로컬의 새 커밋으로 덮어씁니다.
        run: |
          git push --force origin HEAD:main
